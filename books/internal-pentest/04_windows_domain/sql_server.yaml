name: windows_domain_sql_server

info:
  title: Windows SQL-Server Audit
  author: evait security GmbH
  book: internal-pentest
  category: 04_windows_domain
  placeholder: 
    - SMBUser
    - SMBPass
    - SMBDomain
  references:
    - https://github.com/NetSPI/PowerUpSQL
    - https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

content: |
  <p>Use PowerUpSQL on a Windows based machine in order to audit any domain joined Windows SQL server. First, we need a shell under a doamin user context.</p>
  <code>runas /netonly /user:@@SMBDomain\@@SMBUser powershell.exe</code>
  <p>The program ask for a password so just paste in</p>
  <code>@@SMBPass</code>
  <p>Now install the PowerUpSQL module (current session only) using the following command:</p>
  <code>IEX(New-Object System.Net.WebClient).DownloadString("https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.ps1")</code>
  <p><em>Hint: This will actually not work on linux powershell. Also the "-Username, -Password, -DomainController parameters not working as expected. So "runas" is needed."</em></p>
  <p>The following command will auto-discover all MSSSQL SPNs and directly run all audit scripts</p>
  <code>Get-SQLInstanceDomain -Verbose | Invoke-SQLAudit > results.txt</code>