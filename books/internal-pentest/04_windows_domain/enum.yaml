name: windows_domain_enum

info:
  title: Windows Domain Enumeration
  author: evait security GmbH
  book: internal-pentest
  category: 04_windows_domain
  placeholder: 
    - SMBUser
    - SMBPass
    - SMBDomain
    - SMBDomainController
  references:
    - https://github.com/fox-it/BloodHound.py

content: |
  <h3>Bloodhound</h3>
  <p>Enumerate domain using bloodhound.py ingestor</p>
  <code>python3 bloodhound.py -u @@SMBUser -p '@@SMBPass' -d @@SMBDomain -c All</code>
  <p>Import data into bloodhound ui</p>
  <code>sudo systemctl start neo4j.service</code>
  <p>Start bloodhound ui and import the json files</p>
  <h3>LDAP Domain Dump</h3>
  <code>ldapdomaindump -u "@@SMBDomain\@@SMBUser" -p '@@SMBPass' @@SMBDomainController</code>
  <p>Extract usernames</p>
  <code>cat domain_users.grep | cut -f 3 | sort -u</code>
  <p>Extract all email adresses</p>
  <code>grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" domain_users.json | sort -u</code>
  <p>Extract email adresses from email attribute</p>
  <code>cat domain_users.json|jq ".[].attributes.mail" | ag -v null | jq ".[]" -r | sort -u</code>
  <p>Resolve all active domain computers and get /24 subnets</p>
  <code>cat domain_computers.grep | cut -f 3 | tr '[:lower:]' '[:upper:]' | ag @@SMBDomain | sort -u | xargs -I _ host _ | grep address | cut -d ' ' -f 4 | cut -d "." -f 1,2,3 | sort -u</code>